#!/bin/sh

#
# prep_test.sh <config filename> <arch filename>
#

ICSIM_DIR=/nobackup/wangda/icsim
SIM=$ICSIM_DIR/sim/sim
CAD=$ICSIM_DIR/cad/bamboo


if [ ! -n "$1" ] || [ ! -n "$2" ]
then
    echo "Usage: `basename $0` <config filename> <arch filename> [Optional <trace_router_id>]"
    exit 1
fi


#
# Check if we're doing a single-router test
#
if [ -n "$3" ]
then
    TRACE_ROUTER_ID=$3
else
    TRACE_ROUTER_ID=-1
fi

#
# Check that the supplied config and architecture files are valid
#
CONFIG_FILE=$1
ARCH_FILE=$2

if [ ! -f "$CONFIG_FILE" ]
then
    echo "Can't find config file '$CONFIG_FILE'"
    exit 2
fi

if [ ! -f "$ARCH_FILE" ]
then
    echo "Can't find Architecture Description File '$ARCH_FILE'"
    exit 3
fi

#
# Echo input parameters
#
echo $ICSIM_DIR
echo $SIM
echo $CAD
echo $CONFIG_FILE
echo $ARCH_FILE
echo $TRACE_ROUTER_ID


OUT_SIM_PLACE=test_sim_place
OUT_CONFIG_BIN=test_config.bin
OUT_CAD=test_out_cad
OUT_SIM_TRACE=test_sim_trace
OUT_SIM=test_out_sim

#
# Run CAD tool to generate the configuration bytes
# Run simulator using the configuration generated by the CAD tool
#
if [ $TRACE_ROUTER_ID != -1 ]
then
    # Generate byte streams for only 1 router nodes. This is used to test the Router
    $CAD -a $ARCH_FILE -u $CONFIG_FILE -s $OUT_SIM_PLACE -t $TRACE_ROUTER_ID -o $OUT_CONFIG_BIN -v > $OUT_CAD
    $SIM $CONFIG_FILE 0 1000 -p $OUT_SIM_PLACE -t $TRACE_ROUTER_ID $OUT_SIM_TRACE -v > $OUT_SIM
else
    # Generate byte stream for the entire system
    $CAD -a $ARCH_FILE -u $CONFIG_FILE -s $OUT_SIM_PLACE -o $OUT_CONFIG_BIN -v > $OUT_CAD
    $SIM $CONFIG_FILE 0 1000 -p $OUT_SIM_PLACE -v > $OUT_SIM
fi


echo "The following files have been created:"
echo "  CAD"
echo "    $OUT_CONFIG_BIN    Configuration bytestream"
echo "    $OUT_SIM_PLACE     Partition node placement file"
echo "    $OUT_CAD       CAD program output"
echo "  Sim"
echo "    $OUT_SIM_TRACE     Simulator trace file"
echo "    $OUT_SIM       Simulator output"


